# A股市场每日分析系统 - 程序架构设计

## 1. 系统架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                        定时任务调度层 (Cron)                      │
│  ┌──────────────────┐  ┌──────────────────┐  ┌─────────────┐  │
│  │ 每日A股报告 16:00 │  │ A股指数监控 15:30│  │工作计划 10:00│  │
│  └──────────────────┘  └──────────────────┘  └─────────────┘  │
└─────────────────────────────────────────────────────────────────┘
                                  │
                                  ▼
┌─────────────────────────────────────────────────────────────────┐
│                         数据收集层                               │
│  ┌─────────────┐  ┌─────────────────┐  ┌────────────────────┐  │
│  │ 行情收集器   │  │  期货收集器      │  │    新闻收集器       │  │
│  │ collector.js│  │futures-browser.js│  │   collector.js    │  │
│  └─────────────┘  └─────────────────┘  └────────────────────┘  │
│         │                  │                      │            │
│         ▼                  ▼                      ▼            │
│    腾讯财经            东方财富(浏览器)           格隆汇          │
└─────────────────────────────────────────────────────────────────┘
                                  │
                                  ▼
┌─────────────────────────────────────────────────────────────────┐
│                         数据存储层                               │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                    storage.js                            │   │
│  │   market_YYYY-MM-DD.json   futures_YYYY-MM-DD.json      │   │
│  │   news_YYYY-MM-DD.json    basis_YYYY-MM-DD.json        │   │
│  └─────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
                                  │
                                  ▼
┌─────────────────────────────────────────────────────────────────┐
│                         质量检查层                               │
│  ┌────────────────┐  ┌────────────────┐  ┌─────────────────┐   │
│  │data-validator.js│  │ data-retry.js │  │ data-quality.js │   │
│  │  (验证规则)     │  │   (重试机制)   │  │  (质量评分)     │   │
│  └────────────────┘  └────────────────┘  └─────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
                                  │
                                  ▼
┌─────────────────────────────────────────────────────────────────┐
│                         数据分析层                               │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                    analyzer.js                           │   │
│  │  ┌───────────┐  ┌───────────┐  ┌───────────────────┐   │   │
│  │  │成交量分析  │  │ 基差分析  │  │    新闻情绪分析    │   │   │
│  │  └───────────┘  └───────────┘  └───────────────────┘   │   │
│  └─────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
                                  │
                                  ▼
┌─────────────────────────────────────────────────────────────────┐
│                         报告生成层                               │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                    reporter.js                           │   │
│  │   行情分析 → 新闻分析 → 基差分析 → 综合结论              │   │
│  └─────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
                                  │
                                  ▼
┌─────────────────────────────────────────────────────────────────┐
│                         输出层 (飞书)                            │
│                    消息推送到用户 DM                            │
└─────────────────────────────────────────────────────────────────┘
```

## 2. 模块说明

### 2.1 数据收集模块

| 文件 | 功能 | 输入 | 输出 |
|------|------|------|------|
| `market-data-collector/collector.js` | 采集8个指数行情 | - | JSON |
| `market-data-collector/futures-browser.js` | 采集期货数据 | - | JSON |
| `market-news-collector/collector.js` | 采集新闻 | - | JSON |

### 2.2 数据存储模块

| 文件 | 功能 |
|------|------|
| `storage.js` | JSON 文件读写 |

### 2.3 交易日历模块

| 文件 | 功能 |
|------|------|
| `trading-calendar.js` | 交易日判断、到期日计算 |

### 2.4 质量保证模块

| 文件 | 功能 |
|------|------|
| `data-validator.js` | 数据验证规则 |
| `data-retry.js` | 重试机制 |
| `data-quality.js` | 质量评分 |

### 2.5 分析模块

| 文件 | 功能 |
|------|------|
| `market-analyzer/analyzer.js` | 成交量、基差、新闻分析 |
| `report-generator/reporter.js` | 报告生成 |

## 3. 数据流程

```
1. Cron 触发 (16:00)
           │
           ▼
2. 执行 collector.js indices    → 行情数据
           │
           ▼
3. 执行 futures-browser.js     → 期货数据
           │
           ▼
4. 执行 collector.js           → 新闻数据
           │
           ▼
5. data-quality.js 检查        → 评分>=70?
           │                      │
           ├── 否 → 重新抓取 (最多3次)
           │
           ▼ 是
6. analyzer.js 分析            → 分析结果
           │
           ▼
7. reporter.js 生成报告        → Markdown
           │
           ▼
8. 飞书消息推送               → 用户DM
```

## 4. 核心算法

### 4.1 基差计算

```python
基差 = 期货价格 - 现货价格
基差率 = (基差 / 现货价格) × 100%
年化基差率 = 基差率 × (365 / 距到期交易日)
```

### 4.2 质量评分

```
总分 = 100
扣分:
  - 行情数据缺失 = -20分/项
  - 期货数据缺失 = -15分/项
  - 新闻数据缺失 = -10分
  - 数据异常 = -3分/条
  
通过: >= 70分
```

## 5. 文件结构

```
/root/.openclaw/workspace/skills/market-analyst/
├── market-data-collector/
│   ├── collector.js           # 行情+新闻收集
│   └── futures-browser.js      # 期货收集
├── market-analyzer/
│   ├── analyzer.js            # 数据分析
│   ├── storage.js             # 数据存储
│   └── data/                  # 数据文件
├── report-generator/
│   └── reporter.js            # 报告生成
├── trading-calendar.js        # 交易日历
├── data-quality.js            # 质量检查
├── data-validator.js          # 验证规则
├── data-retry.js              # 重试机制
└── docs/
    ├── REQUIREMENTS.md        # 需求文档
    ├── DESIGN.md              # 设计文档
    ├── REVIEW.md              # 评审文档
    └── DATA_QUALITY.md        # 质量设计
```

## 6. 定时任务

| 任务名 | 时间 | 功能 |
|--------|------|------|
| 每日A股报告 | 16:00 | 收集→分析→报告 |
| A股指数监控 | 15:30 | 涨跌幅监控 |
| 每日工作计划 | 10:00 | 工作计划推送 |

---

*文档版本: 1.0*
*更新日期: 2026-02-27*
