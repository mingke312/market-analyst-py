# 数据质量保证模块设计

## 1. 模块架构

```
数据收集流程
    │
    ▼
┌─────────────────┐
│  数据源检查     │ ← 检查数据源是否可用
└─────────────────┘
    │
    ▼
┌─────────────────┐
│  数据采集       │
└─────────────────┘
    │
    ▼
┌─────────────────┐
│  数据验证       │ ← 验证数据完整性
└─────────────────┘
    │
    ▼
┌─────────────────┐
│  质量评分       │ ← 计算质量分数
└─────────────────┘
    │
    ▼
    是否通过(>=70分)?
    │
    ├── 是 → 保存数据
    │
    └── 否 → 重新采集 (最多3次)
```

## 2. 验证规则

### 2.1 行情数据验证规则

| 字段 | 必填 | 类型 | 范围 | 错误处理 |
|------|------|------|------|----------|
| code | 是 | string | 非空 | 重试 |
| name | 是 | string | 非空 | 重试 |
| price | 是 | number | >0 | 重试 |
| changePercent | 是 | number | -20~20 | 警告 |
| volume | 是 | number | >=0 | 警告 |
| amount | 是 | number | >=0 | 警告 |

### 2.2 期货数据验证规则

| 字段 | 必填 | 类型 | 范围 | 错误处理 |
|------|------|------|------|----------|
| index (IF/IC/IM/IH) | 是 | string | 4选 | 重试 |
| contract (当月/下季/隔季) | 是 | string | 3选 | 警告 |
| price | 是 | number | >0 | 重试 |
| settlement | 否 | number | >0 | 警告 |

### 2.3 新闻数据验证规则

| 字段 | 必填 | 类型 | 范围 | 错误处理 |
|------|------|------|------|----------|
| title | 是 | string | 非空 | 跳过 |
| category | 是 | string | 有效分类 | 跳过 |
| url | 是 | string | 有效URL | 跳过 |

## 3. 质量评分算法

```
总分 = 100分

扣分项：
├── 行情数据缺失 = -20分/项
├── 行情字段为空 = -5分/项
├── 期货数据缺失 = -15分/项
├── 新闻数据缺失 = -10分
├── 数据异常警告 = -3分/条
└── 连续失败 = -10分/次

通过标准：>= 70分
```

## 4. 重试机制

```
最大重试次数：3次
重试间隔：10秒
重试策略：
  第1次失败 → 等待10秒重试
  第2次失败 → 等待20秒重试
  第3次失败 → 记录错误，生成告警
```

## 5. 数据完整性检查清单

### 5.1 行情数据 (8个指数)
- [ ] sh000001 上证指数
- [ ] sz399001 深证成指
- [ ] sh000300 沪深300
- [ ] sh000905 中证500
- [ ] sh000852 中证1000
- [ ] sh000016 上证50
- [ ] sh000688 科创50
- [ ] sz399006 创业板指

### 5.2 期货数据 (4指数 × 3合约)
- [ ] IF 当月/下季/隔季
- [ ] IC 当月/下季/隔季
- [ ] IM 当月/下季/隔季
- [ ] IH 当月/下季

## 6. 质量报告模板

```
📋 数据质量报告
━━━━━━━━━━━━━━━━━━━━

【行情数据】8/8 ✓
  上证指数    4146.63 ✓
  深证成指   14503.79 ✓
  沪深300    4726.87 ✓
  ...

【期货数据】10/11 ✓
  IF当月    4712.2 ✓
  IF下季    4671.2 ✓
  IC隔季    - (无数据)

【新闻数据】20条 ✓

━━━━━━━━━━━━━━━━━━━━
评分: 85/100 ✅ 通过

建议: 
- 建议关注期货IC隔季数据
```

## 7. 实现文件

- `data-quality.js` - 质量检查核心模块
- `data-validator.js` - 数据验证规则
- `data-retry.js` - 重试机制
